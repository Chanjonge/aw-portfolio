# 이미지 노출 문제 해결 가이드

## 🔍 문제 확인

이미지 업로드는 성공했지만 프론트엔드에서 보이지 않는 경우

---

## ✅ 체크리스트

### 1. Vercel Blob Storage가 생성되었는지 확인

**Vercel Dashboard → Storage**

-   Blob Storage가 생성되어 있어야 함
-   `BLOB_READ_WRITE_TOKEN` 환경 변수가 자동으로 추가됨

---

### 2. 업로드된 이미지 URL 확인

#### 방법 A: 브라우저 개발자 도구로 확인

1. 관리자 페이지에서 이미지 업로드
2. **F12** (개발자 도구) → **Network** 탭
3. 업로드 요청 찾기 (`/api/upload`)
4. Response 확인

**올바른 형식:**

```json
{
    "url": "https://xxx.public.blob.vercel-storage.com/uploads/1234567890_image.jpg"
}
```

**잘못된 형식:**

```json
{
    "url": "/uploads/1234567890_image.jpg"
}
```

---

### 3. 데이터베이스에 저장된 URL 확인

#### Prisma Studio로 확인

```bash
npm run prisma:studio
```

1. `Portfolio` 또는 `Question` 테이블 열기
2. `thumbnail` 필드 확인
3. URL이 전체 URL인지 확인 (`https://`로 시작해야 함)

**올바른 예:**

```
https://abc123.public.blob.vercel-storage.com/uploads/1234567890_image.jpg
```

**잘못된 예:**

```
/uploads/1234567890_image.jpg
```

---

## 🛠️ 해결 방법

### 문제 1: 상대 경로로 저장되어 있는 경우

기존에 파일 시스템으로 업로드했던 이미지들이 상대 경로(`/uploads/...`)로 저장되어 있을 수 있습니다.

**해결:**

1. 관리자 페이지에서 이미지를 다시 업로드
2. 또는 데이터베이스에서 수동으로 수정

---

### 문제 2: Blob Storage가 생성되지 않음

#### 증상

-   업로드 시 500 에러
-   "BLOB_READ_WRITE_TOKEN is not defined" 오류

#### 해결

1. **Vercel Dashboard** 접속
2. 프로젝트 선택
3. **Storage** 탭
4. **Create Database** → **Blob** 선택
5. 이름: `portfolio-uploads`
6. Create

---

### 문제 3: 환경 변수 누락

#### 확인 방법

**Vercel Dashboard → Settings → Environment Variables**

다음이 있는지 확인:

-   `BLOB_READ_WRITE_TOKEN` (Blob Storage 생성 시 자동 추가)
-   `DATABASE_URL`
-   `JWT_SECRET`
-   `NEXTAUTH_SECRET`

없으면 추가 후 재배포!

---

### 문제 4: Next.js 이미지 최적화 문제

외부 URL(Blob Storage)을 사용하는 경우 `next.config.js` 설정 필요

#### next.config.js 확인

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
    images: {
        remotePatterns: [
            {
                protocol: 'https',
                hostname: '**.public.blob.vercel-storage.com',
            },
        ],
    },
};

module.exports = nextConfig;
```

**참고:** 현재 코드는 `<img>` 태그를 사용하므로 이 설정은 선택사항입니다.
`<Image>` 컴포넌트를 사용한다면 필수입니다.

---

## 🔍 디버깅 단계별 가이드

### 1단계: 업로드 테스트

1. 관리자 로그인: `https://aw-portfolio-chi.vercel.app/admin/login`
2. Super Admin 페이지 또는 포트폴리오 편집
3. 이미지 업로드 시도
4. F12 → Network 탭에서 `/api/upload` 요청 확인

**성공 시:**

```json
{
    "url": "https://xxx.public.blob.vercel-storage.com/uploads/..."
}
```

**실패 시:**

-   500 에러 → Vercel 로그 확인
-   401/403 에러 → 인증 문제
-   BLOB_READ_WRITE_TOKEN 오류 → Blob Storage 생성 필요

---

### 2단계: DB에 저장 확인

Prisma Studio 또는 MongoDB Atlas에서:

-   Portfolio/Question의 thumbnail 필드
-   전체 URL이 저장되었는지 확인

---

### 3단계: 프론트엔드 렌더링 확인

1. 메인 페이지 접속
2. F12 → Elements 탭
3. `<img>` 태그의 `src` 속성 확인

**정상:**

```html
<img src="https://xxx.public.blob.vercel-storage.com/uploads/..." />
```

**문제:**

```html
<img src="/uploads/..." />
```

→ 상대 경로는 Vercel에서 작동하지 않음

---

### 4단계: 이미지 직접 접속

브라우저 주소창에 이미지 URL을 직접 입력:

```
https://xxx.public.blob.vercel-storage.com/uploads/1234567890_image.jpg
```

-   **이미지 표시됨** → DB 문제 (잘못된 URL 저장)
-   **403/404 에러** → Blob Storage 문제
-   **로딩 안 됨** → 네트워크 문제

---

## 🚀 빠른 해결 (대부분의 경우)

### 시나리오 1: Blob Storage를 생성하지 않음

```
1. Vercel → Storage → Create Database → Blob
2. 이름: portfolio-uploads
3. Create
4. 자동 재배포 대기 (1-2분)
5. 이미지 다시 업로드
```

### 시나리오 2: 기존 이미지가 상대 경로로 저장됨

```
1. 관리자 페이지에서 각 포트폴리오/질문 편집
2. 이미지를 다시 업로드
3. 저장
```

---

## 📝 현재 Upload API 확인

현재 `app/api/upload/route.ts`가 다음과 같이 되어있는지 확인:

```typescript
// Vercel Blob에 업로드
const blob = await put(filename, file, {
    access: 'public',
});

// URL 반환
return NextResponse.json({ url: blob.url }, { status: 200 });
```

**중요:** `blob.url`을 반환해야 전체 URL이 저장됩니다!

---

## ⚠️ 로컬 vs 프로덕션

### 로컬 개발

-   Blob Storage 토큰이 `.env`에 있어야 함
-   또는 기존 파일 시스템 방식 사용

### 프로덕션 (Vercel)

-   Blob Storage 생성 시 자동으로 토큰 설정
-   파일 시스템 사용 불가

---

## 🆘 여전히 안 되면?

1. **Vercel 로그 확인**

    - Deployments → 최신 배포 → Functions 탭
    - 오류 메시지 확인

2. **브라우저 콘솔 확인**

    - F12 → Console 탭
    - 이미지 로딩 오류 확인

3. **스크린샷 공유**
    - Network 탭의 `/api/upload` 응답
    - 저장된 이미지 URL
    - 오류 메시지

---

문제가 계속되면 위 정보들을 확인 후 알려주세요!
